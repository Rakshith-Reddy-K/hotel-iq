name: Backend Tests

on:
  pull_request:
    branches: [dev, production]
  push:
    branches: [production]

permissions:
  contents: read
  pull-requests: write

jobs:
  run-tests:
    name: Run Backend Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./model_pipeline/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        continue-on-error: true
        id: pytest
        env:
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
        run: |
          pytest tests/test_ci.py \
            -v \
            --tb=short \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            | tee pytest-output.txt

          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Generate summary
        if: always()
        id: summary
        run: |
          # Count results
          TOTAL=$(grep -oP '\d+(?= passed)' pytest-output.txt || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' pytest-output.txt || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' pytest-output.txt || echo "0")
          PASSED=$((TOTAL - FAILED - SKIPPED))

          # Get coverage
          COVERAGE=$(grep -oP '\d+%' pytest-output.txt | tail -1 || echo "0%")

          # Get duration
          DURATION=$(grep -oP '[\d.]+s' pytest-output.txt | tail -1 || echo "0s")

          # Create comment
          if [ "$FAILED" = "0" ]; then
            STATUS="âœ… All Tests Passed"
            EMOJI="ðŸŽ‰"
          else
            STATUS="âŒ Tests Failed"
            EMOJI="âš ï¸"
          fi

          # Build comment for PR
          COMMENT="### ${EMOJI} Backend Tests

          | Status | Passed | Failed | Skipped | Coverage | Duration |
          |--------|--------|--------|---------|----------|----------|
          | ${STATUS} | âœ… ${PASSED} | âŒ ${FAILED} | â­ï¸ ${SKIPPED} | ðŸ“Š ${COVERAGE} | â±ï¸ ${DURATION} |"

          # ======================================
          # LOG TO JOB RUN (appears in Actions log)
          # ======================================
          echo ""
          echo "========================================="
          echo "${EMOJI} Backend Test Results"
          echo "========================================="
          echo "Status:   ${STATUS}"
          echo "Passed:   ${PASSED}"
          echo "Failed:   ${FAILED}"
          echo "Skipped:  ${SKIPPED}"
          echo "Coverage: ${COVERAGE}"
          echo "Duration: ${DURATION}"
          echo "========================================="
          echo ""

          # ======================================
          # ADD TO GITHUB STEP SUMMARY (appears in job summary page)
          # ======================================
          echo "### ${EMOJI} Backend Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Passed | Failed | Skipped | Coverage | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|--------|---------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${STATUS} | âœ… ${PASSED} | âŒ ${FAILED} | â­ï¸ ${SKIPPED} | ðŸ“Š ${COVERAGE} | â±ï¸ ${DURATION} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ======================================
          # SAVE TO OUTPUT (for PR comment)
          # ======================================
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `${{ steps.summary.outputs.comment }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail if tests failed
        if: steps.pytest.outputs.exit_code != '0'
        run: exit 1
