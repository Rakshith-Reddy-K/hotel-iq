version: '3.8'

# Production Docker Compose Configuration
# ========================================
# Use: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        - BUILD_ENV=production
    environment:
      - ENVIRONMENT=production
      # GCP credentials location in container
      - GOOGLE_APPLICATION_CREDENTIALS=/app/config/gcp-service-account.json
    command: ["gunicorn", "main:app", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000", "--timeout", "120"]
    volumes:
      # GCP credentials (read-only)
      - ./backend/config:/app/config:ro
      # Data directory (populated from GCS on startup)
      - hoteliq-data:/app/data
      # Preserve booking requests
      - ./booking_requests.json:/app/booking_requests.json
      # Persistent logs
      - hoteliq-logs:/app/logs
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  redis:
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  nginx:
    profiles: []  # Enable nginx in production

volumes:
  hoteliq-data:
    driver: local

